---
layout: post
title:  "Universe!"
date:   2013-08-23 14:18:42
categories: project universe
---
# About

I played Black Stars [1](http://navissal.com/projets/Black%20Stars) [2](https://itunes.apple.com/us/app/black-stars/id512945753?mt=8) recently a lot,
and I am wondering how difficult it would be to recreate the game in Javascript?

For those who don´t know, the game is a pretty simple but addicting RTS, where you conquer planets against an AI (or even multiplayer).
It´s a bit like Risk, but faster.

Here is what it looks like:

![Black Stars Screenshot](/img/BlackStarsScreenShot.png)


# The challange...
... is to rewrite the Game logic in Javascript. I´d like to write a module that can
process moves and return the new world state as a result.

# The rules
The game consists of players, planets ( with units ) and fleets

## Planets:

* Every second the planet produces new units, defined by the planets production level ( 1 to 3 ). The higher the production level, the more units a produced per second.
* Each planet has a defined set of links to other planets, which can be set, but never destroyed
* The planet can be upgraded 3 times in total, either upgrading its production level or its defense level
* When a fleet reaches a planet, and the fleets owner is not the planets owner, there is battle and the planet defends itself (based on its defense level). If the planet´s and fleet´s player match, the units stationed on the planet are reinforced by the fleet and the fleet is disbanded.
* When a planet is attacked, number of units on planets times a factor given by the planets defense level are compared to the number of ships in the attacking fleet. The larger number wins. If it is the fleet, the planet is conquered.
* Planets may neutral (= not owned by a player). In this case they keep their initial number of units and do not produce new ones.


## Fleets:

* If you send units from one planet to another, you create a fleet
* The fleet takes all of the ships that are stationed on the planet and immediately travels to the destination planet.
* Fleets can only travel over existing links between planets.
* A fleet reaching a planet either reinforces or tries to invade the planet.
* If a fleet invades a planet it automatically is owned by the fleet´s owner and the fleet is disbanded.
* If fleets meet in space there is a space battle. The fleet with more ships wins. If both fleets have the same amount of ships, both are eliminated.


## Winning

* The game is over when one player defeats all other players (no planets left)  

# The attack plan

That is it basically. It should be pretty easy to write a set of tests for this specification. Based on these tests i want to write a Javascript module that, given a certain game state and a time can calculate the new game state based on the rules above.


# The main function

My idea is to have a single function that takes the game state as a single parameter and returns the advanced, proceessed state.

Something like:

{% highlight javascript %}
var state = game.getInitialState();
while ( !state.gameOver ) {
    state = game.advanceState( state );
}
{% endhighlight %}

# The state

The game state aka "the model" in in MVC pattern, contains every bit needed
to display the current game situation and to advance the current game situation applying
the rules above.

For simplicity there is no history, and I´ll keep the complete game in a variable
(for now). It would be nice for later to serialize / deserialze the state into a
JSON string to put it into a database.

So what is in the state?

* Current step ( = time ) [ int ]
* Planets [ array ]
    + id [ int ]
    + owner [ int ]
    + # of units [ int ]
    + production level [ int ]
    + defense level [ int ]
    + links to other planets  [ Array of id´s ]
    + position [ array of objects with { x / y } ]
* Fleets
    + id [ int ]
    + owner [ int ]
    + source planet [ int ]
    + destination planet [ int ]
    + step nr when started [ int ]
    + step nr when arrives [ int ]
* Players
    + id [ int ]
    + name "string"
    + nr of planets in control [ int ]


{% highlight javascript %}
function getinitialstate() {
    return {
        step: 0,
        planets: [],
        fleets: [],
        players: []
    };
}
{% endhighlight %}

Of course we want to add some data to our empty state. Here is what we need to
initialze a level.

* add players ( name ) -> playerId
* add planets ( position, owner, startUnits ) -> planetId
* link planets ( planetId, planetId )

Helper functions to manage planets:
* upgradeProduction( planetId )
* upgradeDefenses ( planetId )

Here is a minimalistic implementation of these methods. So far, I did not implement
error handling and id checking, to keep the examples simple. To add this later,
I simply have to advance my test cases to make the implementation more rebust.

{% highlight javascript %}

addPlayer: function( name ) {
    this.players.push( {
        name: name
    } );
    return this.players.length - 1;
},
addPlanet: function( position, owner, units ) {
    this.planets.push( {
        id: 0,
        owner: owner,
        units: units,
        position: position,
        pLevel: 1,
        dLevel: 1,
        links: []
    } );
    return this.planets.length - 1;
},
linkPlanets: function( planetId1, planetId2 ) {
    var planet1 = this.planets[ planetId1 ],
        planet2 = this.planets[ planetId2 ];
    planet1.links.push( planetId2 );
    planet2.links.push( planetId1 );
},
upgradeProduction: function( planetId ) {
    if ( this.planets[ planetId ].pLevel < MAX_PLEVEL ) {
        this.planets[ planetId ].pLevel += 1;
        return true;
    }
    return false;
},
upgradeDefense: function( planetId ) {
    if ( this.planets[ planetId ].dLevel < MAX_DLEVEL ) {
        this.planets[ planetId ].dLevel += 1;
        return true;
    }
    return false;
}

{% endhighlight %}

Okay, now I can create, link and uprade planets. One thing missing is that planets grow over time,
so the advanceState() function needs some adjustment.

{% highlight javascript %}
function advancePlanets( state ) {
    for ( var i = 0, j = state.planets.length; i < j; i++ ) {
        var planet = state.planets[ i ];
        planet.units += 1 * PRODUCTIONRATE[ planet.pLevel ];
    }
}
{% endhighlight %}
