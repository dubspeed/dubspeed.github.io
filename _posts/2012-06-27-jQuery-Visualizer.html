---           
layout: post
title: jQuery Visualizer
date: 2012-06-27 16:36:10 UTC
updated: 2012-06-27 16:36:10 UTC
comments: false
categories: Javascript jQVis
---

Some more Javascript, DOM manipulation and TDD, w/ an example project, see live at <a href="http://dubspeed.github.com/jqVis">dubspeed.github.com/jqVis</a><br /><br /><a href="http://www.blogger.com/blogger.g?blogID=20275042" name="more"></a><b>What and Why</b><br /><br />The goal is to refresh my knowledge about the Javascript development process and the tools and frameworks involved in this process.<br /><br /><b>Building the app</b><br /><br />The app should start as simple as possible and advance over time.<br /><br />It´s interface should be split into three parts: a header, a query area and a source code area.<br /><br />The final version should include an iFrame HTML element to render the page, but we start withno rendering yet.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-rtd906Nlv8U/T9ntReJ0ncI/AAAAAAAAAHo/dU4b6G5XPqE/s1600/jqvis_simple.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="168" src="http://2.bp.blogspot.com/-rtd906Nlv8U/T9ntReJ0ncI/AAAAAAAAAHo/dU4b6G5XPqE/s400/jqvis_simple.png" title="" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">early HTML sketch of what the app could like</td></tr></tbody></table><br />For the code and all the resources, I set up a git repro at github: <a href="https://github.com/dubspeed/jqVis">here</a><br /><br />I could start the development writing code down from the HTML sketch, adding functionality step by step, but I focus on the library coding here.<br /><br /><br /><a name='more'></a><br /><br /><br /><b>The jqvis Library</b><br /><br />The TDD tools I used to develop the jqvis library where quite simple, mainly because the lib did nothing like ajax or timeouts. <br /><br /><b>The application logic</b><br /><br />So, lets say I have a web page with an editor on it and someone pasted HTML and pressed the query button, what should happen?<br /><br />First, the HTML should get extracted as text and inserted into the browser DOM at a place where I can run jQuery on it. That can be a &lt;div&gt; or, advanced, and &lt;irframe&gt;.<br /><br />The next step is to run a jquery Query on the children of my &lt;div&gt; and get a result.<br /><br />Next, the tricky part comes: match the result from the query back to the HTML in the editor. That is tricky because jQuery or the browser do not tell me and when I compile HTML into a DOM I can never be sure what the browser does with the code.<br /><br />I did not find a solution to the problem that does not - at least - relies on the fact that browsers do no harm to all the linebreaks in the code.<br /><br />The resulting HTML-tags get wrapped in a special &lt;wrap&gt; tag, like so: &lt;p&gt;foo&lt;/p&gt; becomes &lt;wrap&gt;&lt;p&gt;foo&lt;/p&gt;&lt;wrap&gt;.<br /><br />The I count all the linebreaks between each &lt;wrap&gt;&lt;/wrap&gt; et voilá. <br /><b><br /></b><br /><b>Implementation</b><br /><br />I want to decouple the view with the logic, so I keep the DOM which I build from the HTML in the editor separate from the rendering window, and I keep a copy of the HTML in a private variable as well, so I can play with it. <br /><br /><br />Here is the interface I came up with:<br /><br /><pre class="brush:javascript;">&nbsp;&nbsp;&nbsp; // Public API<br />&nbsp;&nbsp;&nbsp; jqvis.setHTML = sethtml;<br />&nbsp;&nbsp;&nbsp; jqvis.getHTML = gethtml;<br />&nbsp;&nbsp;&nbsp; jqvis.getDOM = getDOM;<br />&nbsp;&nbsp;&nbsp; jqvis.query = query;<br />&nbsp;&nbsp;&nbsp; jqvis.setMark = setMark;<br />&nbsp;&nbsp;&nbsp; jqvis.getLines = getLines;<br /></pre><br />The usage is pretty straight forward:<br /><br />You set some HTML with the setHTML method and define a marker (e.g. &lt;wrap&gt; or something) you want the results wrapped in. Next you run the Query you want. At last you fetch the lines numbers you have a result for via the getLines method.<br /><br /><b>Some details</b><br /><br />The only interesting method here is getLines, which does all the line counting for us. It looks like this<br /><br /><pre class="brush:javascript;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; getLines = function() {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (!_openMark) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; throw {name:"TypeError", message: "No mark set"};<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (_html === "") {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; throw {name:"TypeError", message: "set HTML first"};<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var lines = _html.split("\n");<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var result = [];<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var mode = "end";<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; for (var i = 0; i &lt; lines.length; i += 1){<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (lines[i].indexOf(_openMark) != -1) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; mode = "start";<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (mode === "start") {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; result.push(i);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (lines[i].indexOf(_closeMark) != -1) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; mode = "end";<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; clear(_markTag);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return result;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; },<br /></pre><br />It is basically a state machine that gets turned to "on" every time it finds a start marker and turned of when the end marker is reached. The three if-statements in the loop are important, because they allow the state "on" and "off" and the count +=1 to happen in the same line (e.g. &lt;mark&gt;foo&lt;/mark&gt;)<br /><br /><b>Conclusion</b><br /><br />The first iteration over the problem went quite well and smooth, and it does what I should do. The presented solution leaves room for improvements and it has it bugs and flaws. The next iteration will refine that and add more cool features.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-YgwCQrRYpJM/T-IQZKbAPeI/AAAAAAAAAH0/D8_dOUs7JDY/s1600/Bildschirmfoto+2012-06-20+um+20.00.34.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="178" src="http://4.bp.blogspot.com/-YgwCQrRYpJM/T-IQZKbAPeI/AAAAAAAAAH0/D8_dOUs7JDY/s400/Bildschirmfoto+2012-06-20+um+20.00.34.png" title="" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Final touches for Version 1: colors and design added</td></tr></tbody></table>See the version 1 live at <a href="http://jqvis.dubspeed.de/jqvis">jqvis.dubspeed.de</a>